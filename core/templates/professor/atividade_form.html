<!-- backend/core/templates/professor/atividade_form.html -->
{% extends 'base.html' %}

{% block title %}
    {% if form.instance.pk %}Editar{% else %}Nova{% endif %} Atividade - SmartClass
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="mb-6">
        <a href="{% url 'professor_atividades' %}"
           class="text-blue-600 hover:text-blue-700 font-medium inline-flex items-center">
            <i class="fas fa-arrow-left mr-2"></i>
            Voltar para Atividades
        </a>
    </div>

    <div class="bg-white rounded-lg shadow-lg p-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-8">
            <i class="fas fa-file-alt mr-2 text-blue-600"></i>
            {% if form.instance.pk %}Editar{% else %}Nova{% endif %} Atividade
        </h1>

        <!-- Card de Geração com IA -->
        <div class="bg-gradient-to-r from-purple-50 to-blue-50 border-2 border-purple-200 rounded-lg p-6 mb-8">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <i class="fas fa-magic text-purple-600 text-3xl"></i>
                </div>
                <div class="ml-4 flex-1">
                    <h3 class="text-lg font-bold text-gray-900 mb-2">
                        Gerar Atividade com IA
                    </h3>
                    <p class="text-gray-600 mb-4">
                        Use inteligência artificial para criar uma atividade personalizada.
                        Preencha os campos abaixo e clique em gerar.
                    </p>

                    <!-- Formulário de IA -->
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Tema -->
                            <div>
                                <label for="ia-tema" class="block text-sm font-medium text-gray-700 mb-1">
                                    Tema da Atividade *
                                </label>
                                <input type="text"
                                       id="ia-tema"
                                       placeholder="Ex: Revolução Francesa"
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>

                            <!-- Disciplina -->
                            <div>
                                <label for="ia-disciplina" class="block text-sm font-medium text-gray-700 mb-1">
                                    Disciplina
                                </label>
                                <select id="ia-disciplina"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                    <option value="">Selecione...</option>
                                    <option value="Matemática">Matemática</option>
                                    <option value="Português">Português</option>
                                    <option value="História">História</option>
                                    <option value="Geografia">Geografia</option>
                                    <option value="Ciências">Ciências</option>
                                    <option value="Física">Física</option>
                                    <option value="Química">Química</option>
                                    <option value="Biologia">Biologia</option>
                                    <option value="Inglês">Inglês</option>
                                    <option value="Artes">Artes</option>
                                    <option value="Educação Física">Educação Física</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Nível -->
                            <div>
                                <label for="ia-nivel" class="block text-sm font-medium text-gray-700 mb-1">
                                    Nível de Dificuldade
                                </label>
                                <select id="ia-nivel"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                    <option value="">Selecione...</option>
                                    <option value="Fácil">Fácil</option>
                                    <option value="Médio">Médio</option>
                                    <option value="Difícil">Difícil</option>
                                    <option value="Avançado">Avançado</option>
                                </select>
                            </div>

                            <!-- Tipo -->
                            <div>
                                <label for="ia-tipo" class="block text-sm font-medium text-gray-700 mb-1">
                                    Tipo de Atividade
                                </label>
                                <select id="ia-tipo"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                    <option value="">Selecione...</option>
                                    <option value="Dissertativa">Dissertativa</option>
                                    <option value="Análise de Texto">Análise de Texto</option>
                                    <option value="Resolução de Problemas">Resolução de Problemas</option>
                                    <option value="Pesquisa">Pesquisa</option>
                                    <option value="Estudo de Caso">Estudo de Caso</option>
                                </select>
                            </div>
                        </div>

                        <!-- Botão Gerar -->
                        <div class="flex justify-end">
                            <button type="button"
                                    onclick="gerarAtividadeIA()"
                                    id="btn-gerar-ia"
                                    class="bg-purple-600 hover:bg-purple-700 text-white font-medium px-6 py-3 rounded-lg transition-colors flex items-center">
                                <i class="fas fa-magic mr-2"></i>
                                Gerar com IA
                            </button>
                        </div>
                    </div>

                    <!-- Loading e Mensagens -->
                    <div id="ia-loading" class="hidden mt-4">
                        <div class="flex items-center text-purple-600">
                            <i class="fas fa-spinner fa-spin mr-2"></i>
                            <span>Gerando atividade com IA...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Formulário Principal -->
        <form method="post" class="space-y-6">
            {% csrf_token %}

            <!-- Título -->
            <div>
                <label for="id_titulo" class="block text-sm font-medium text-gray-700 mb-2">
                    Título da Atividade *
                </label>
                {{ form.titulo }}
                {% if form.titulo.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.titulo.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Descrição -->
            <div>
                <label for="id_descricao" class="block text-sm font-medium text-gray-700 mb-2">
                    Descrição / Enunciado *
                </label>
                {{ form.descricao }}
                {% if form.descricao.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.descricao.errors.0 }}</p>
                {% endif %}
                <p class="mt-1 text-sm text-gray-500">
                    Descreva a atividade de forma clara e detalhada
                </p>
            </div>

            <!-- Prazo -->
            <div>
                <label for="id_prazo_entrega" class="block text-sm font-medium text-gray-700 mb-2">
                    Prazo de Entrega *
                </label>
                {{ form.prazo_entrega }}
                {% if form.prazo_entrega.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.prazo_entrega.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Botões -->
            <div class="flex justify-end gap-3 pt-6 border-t">
                <a href="{% url 'professor_atividades' %}"
                   class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium px-6 py-3 rounded-lg transition-colors">
                    Cancelar
                </a>
                <button type="submit"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-6 py-3 rounded-lg transition-colors flex items-center">
                    <i class="fas fa-save mr-2"></i>
                    {% if form.instance.pk %}Atualizar{% else %}Criar{% endif %} Atividade
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    async function gerarAtividadeIA() {
        const tema = document.getElementById('ia-tema').value.trim();
        const disciplina = document.getElementById('ia-disciplina').value;
        const nivel = document.getElementById('ia-nivel').value;
        const tipo = document.getElementById('ia-tipo').value;

        // Validação
        if (!tema) {
            showToast('Por favor, informe o tema da atividade', 'error');
            return;
        }

        // UI feedback
        const btnGerar = document.getElementById('btn-gerar-ia');
        const loading = document.getElementById('ia-loading');

        btnGerar.disabled = true;
        loading.classList.remove('hidden');

        try {
            const response = await fetch('/api/gerar-atividade/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    tema: tema,
                    disciplina: disciplina,
                    nivel_dificuldade: nivel,
                    tipo_atividade: tipo
                })
            });

            const data = await response.json();

            if (data.success) {
                // Preencher campos do formulário
                document.getElementById('id_titulo').value = data.titulo;
                document.getElementById('id_descricao').value = data.descricao;

                showToast('Atividade gerada com sucesso! Revise e ajuste se necessário.', 'success');

                // Scroll suave para o formulário
                document.getElementById('id_titulo').scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
            } else {
                showToast(data.message || 'Erro ao gerar atividade', 'error');
            }

        } catch (error) {
            console.error('Erro:', error);
            showToast('Erro ao conectar com o servidor', 'error');
        } finally {
            btnGerar.disabled = false;
            loading.classList.add('hidden');
        }
    }

    // Permitir Enter no campo tema
    document.getElementById('ia-tema')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            gerarAtividadeIA();
        }
    });
</script>
{% endblock %}